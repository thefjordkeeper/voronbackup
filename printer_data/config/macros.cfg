###########################################
#MACROS#
###########################################

[gcode_macro G32]
gcode:
    #--------------------------------------------------------------------
    status_leveling
    #--------------------------------------------------------------------
    BED_MESH_CLEAR
    G28
    QUAD_GANTRY_LEVEL
    G28
    ##	Uncomment for for your size printer:
    #--------------------------------------------------------------------
    ##	Uncomment for 250mm build
    #G0 X125 Y125 Z30 F3600
    
    ##	Uncomment for 300 build
    #G0 X150 Y150 Z30 F3600
    
    ##	Uncomment for 350mm build
    G0 X175 Y175 Z30 F3600
    #--------------------------------------------------------------------
    status_ready
    #--------------------------------------------------------------------

    
#####################################################################
#   A better print_start macro for v2/trident
#####################################################################

## *** THINGS TO UNCOMMENT: ***
## Bed mesh (2 lines at 2 locations)
## Nevermore (if you have one)
## Z_TILT_ADJUST (For Trident only)
## QUAD_GANTRY_LEVEL (For V2.4 only)
## Beacon Contact logic (if you have one. 4 lines at 4 locations)

[gcode_macro PRINT_START]
gcode:
  STATUS_HOMING
  G28
  G90
  # This part fetches data from your slicer. Such as bed, extruder, and chamber temps and size of your printer.
  {% set target_bed = params.BED|int %}
  {% set target_extruder = params.EXTRUDER|int %}
  #{% set target_chamber = params.CHAMBER|default("45")|int %}
  {% set x_wait = printer.toolhead.axis_maximum.x|float / 2 %}
  {% set y_wait = printer.toolhead.axis_maximum.y|float / 2 %}
  M106 S0

  ##  Uncomment for Beacon Contact (1 of 4 for beacon contact)
  SET_GCODE_OFFSET Z=0                                 # Set offset to 0

  # Home the printer, set absolute positioning and update the Stealthburner LEDs.
  M82
  ##  Uncomment for bed mesh (1 of 2 for bed mesh)
  BED_MESH_CLEAR
  SET_PIN PIN=nevermore VALUE=1                                       # Clear old saved bed mesh (if any)

  # Check if the bed temp is higher than 90c - if so then trigger a heatsoak.
  #{% if params.BED|int > 90 %}
    SET_DISPLAY_TEXT MSG="Bed: {target_bed}c"           # Display info on display
    STATUS_HEATING                                      # Set LEDs to heating-mode
    M106 S255                                          # Turn on the PT-fan

    ##  Uncomment if you have a Nevermore.
                         # Turn on the nevermore

    G1 X{x_wait} Y{y_wait} Z15 F9000                    # Go to center of the bed
    M190 S{target_bed}                                  # Set the target temp for the bed
    SET_DISPLAY_TEXT MSG="Heatsoak: {target_bed}c"  # Display info on display
    #TEMPERATURE_WAIT SENSOR="temperature_sensor chamber" MINIMUM={target_chamber}   # Waits for chamber temp

  # If the bed temp is not over 90c, then skip the heatsoak and just heat up to set temp with a 5 min soak
  #{% else %}
  #  SET_DISPLAY_TEXT MSG="Bed: {target_bed}c"           # Display info on display
  #  STATUS_HEATING                                      # Set LEDs to heating-mode
  #  G1 X{x_wait} Y{y_wait} Z15 F9000                    # Go to center of the bed
  #   M190 S{target_bed}                                  # Set the target temp for the bed
    # SET_DISPLAY_TEXT MSG="Soak for 5 min"               # Display info on display
  #  G4 P300000                                          # Wait 5 min for the bedtemp to stabilize
  #{% endif %}

  # Heat hotend to 150c. This helps with getting a correct Z-home.
  SET_DISPLAY_TEXT MSG="Hotend: 150c"                   # Display info on display
  STATUS_HEATING
  M104 S150                                             # Heat hotend to 150c
  TEMPERATURE_WAIT SENSOR=extruder MINIMUM={150-2} MAXIMUM={150+2}
  
  STATUS_CLEANING
  SET_DISPLAY_TEXT MSG="Nozzle scrubby scrub"
  CLEAN_NOZZLE_GANTRY

  ##  Uncomment for Beacon contact (2 of 4 for beacon contact)
  STATUS_LEVELING
  G28 Z CARTOGRAPHER_TOUCH_HOME                     # Calibrate z offset and beacon model

  ##  Uncomment for Trident (Z_TILT_ADJUST)
  #SET_DISPLAY_TEXT MSG="Leveling"                      # Display info on display
  #STATUS_LEVELING                                      # Set LEDs to leveling-mode
  #Z_TILT_ADJUST                                        # Level the printer via Z_TILT_ADJUST
  #G28 Z                                                # Home Z again after Z_TILT_ADJUST

  ##  Uncomment for V2.4 (Quad gantry level AKA QGL)
  SET_DISPLAY_TEXT MSG="QGL"                      # Display info on display
  STATUS_LEVELING                                      # Set LEDs to leveling-mode
  QUAD_GANTRY_LEVEL                                    # Level the printer via AGO
  #G28                                                # Home Z again after QGL
  G1 X{x_wait} Y{y_wait} Z15 F9000
  
  SET_DISPLAY_TEXT MSG="Time to tap the bed...gently"
  M109 S0
  SET_HEATER_TEMPERATURE HEATER=heater_bed TARGET=0
  CARTOGRAPHER_TOUCH_HOME
  M190 S{target_bed}
  STATUS_MESHING
                 # Go to center of the bed

  ##  Uncomment for bed mesh (2 of 2 for bed mesh)
  SET_DISPLAY_TEXT MSG="Bed mesh"                      # Display info on display                                       # Set LEDs to bed mesh-mode
  BED_MESH_CALIBRATE                               # Start the bed mesh (add ADAPTIVE=1) for adaptive bed mesh

  ## Uncomment for Beacon Contact (3 of 4 for beacon contact)
  #G28 Z METHOD=CONTACT CALIBRATE=0                     # Calibrate z offset only with hot nozzle
  STATUS_CLEANING
   SET_DISPLAY_TEXT MSG="Nozzle scrubby scrub"
  CLEAN_NOZZLE_GANTRY

  # Heat up the hotend up to target via data from slicer
  SET_DISPLAY_TEXT MSG="Hotend: {target_extruder}c"     # Display info on display
  STATUS_HEATING                                        # Set LEDs to heating-mode
  G1 X{x_wait} Y{y_wait} Z15 F9000                      # Go to center of the bed
  M107                                                  # Turn off partcooling fan
  M109 S{target_extruder}                               # Heat the hotend to set temp

  STATUS_PRINTING
  SET_DISPLAY_TEXT MSG="Line Purge"
  LINE_PURGE
  ##   Uncomment for Beacon Contact (4 of 4 for beacon contact)
  #SET_GCODE_OFFSET Z=0.06                              # Add a little offset for hotend thermal expansion
  # Get ready to print by doing a primeline and updating the LEDs
  SET_DISPLAY_TEXT MSG="Printer goes brr"               # Display info on display
                                                        # Set LEDs to printing-mode
  G0 X{x_wait - 50} Y4 F10000                           # Go to starting point
  G0 Z0.4                                               # Raise Z to 0.4
  G91                                                   # Incremental positioning 
  G90                                                   # Absolute position
[exclude_object]

[gcode_macro PRINT_END]
#   Use PRINT_END for the slicer ending script - please customise for your slicer of choice
gcode:
    M400                           ; wait for buffer to clear
    G92 E0                         ; zero the extruder
    G1 E-20.0 F3600                ; retract filament
    G91                            ; relative positioning
    G0 Z3.00 X20.0 Y20.0 F20000    ; move nozzle to remove stringing
    STATUS_PART_READY
    TURN_OFF_HEATERS
    M107                           ; turn off fan
    G1 Z52 F3000                    ; move nozzle up 50mm
    G90                            ; absolute positioning
    G0  X125 Y250 F3600            ; park nozzle at rear
    SET_SKEW CLEAR=1
    SET_PIN PIN=nevermore VALUE=0
    BED_MESH_CLEAR
    M117

[axis_twist_compensation]
#speed: 50
#   The speed (in mm/s) of non-probing moves during the calibration.
#   The default is 50.
#horizontal_move_z: 5
#   The height (in mm) that the head should be commanded to move to
#   just prior to starting a probe operation. The default is 5.
calibrate_start_x: 10
#   Defines the minimum X coordinate of the calibration
#   This should be the X coordinate that positions the nozzle at the starting
#   calibration position.
calibrate_end_x: 335
#   Defines the maximum X coordinate of the calibration
#   This should be the X coordinate that positions the nozzle at the ending
#   calibration position.
calibrate_y: 175
#   Defines the Y coordinate of the calibration
#   This should be the Y coordinate that positions the nozzle during the
#   calibration process. This parameter is recommended to
#   be near the center of the bed


[gcode_macro CANCEL_PRINT]
rename_existing: BASE_CANCEL_PRINT
gcode:
    SET_IDLE_TIMEOUT TIMEOUT={printer.configfile.settings.idle_timeout.timeout} ; set timeout back to configured value
    CLEAR_PAUSE
    SDCARD_RESET_FILE
    STATUS_READY
    PRINT_END
    BASE_CANCEL_PRINT
    
#[gcode_macro CLEAN_NOZZLE]
#variable_start_x: 315 # starting position - offset a bit to the right from the brush
#variable_start_y: 345 # starting Y position - offset a bit to the front of the brush
#variable_start_z: 4   #starting Z height. This should barely touch the surface of the brush
#variable_x_min: 273     #left side of the brush 
#variable_x_max: 306     #right side of the brush
#variable_y_min: 352 #front side of the brush - make sure the nozzle is over the last line of bristles 
#variable_y_max: 355 #rear side of the brush - make sure the nozzle is over the first line of bristles
#variable_z1: 3.2 # second z height of the nozzle over the brush - this should be with the nozzle slightly sunk in
#variable_z2: 2.4 # third z height of the nozzle over the brush - this should be with the nozzle fully sunk into the brush, but not touching the bottom of it.
#variable_wipe_qty: 2 #how many times to run the cleaning sequence
#variable_wipe_spd: 200 #cleaning speed
#variable_raise_distance: 30 # z height after cleaning is done
#gcode:
#    {% if "xyz" not in printer.toolhead.homed_axes %}
#      G28
#    {% endif %}

#    G90  ; absolute positioning
### Move nozzle to start position
#    G1 X{start_x} Y{start_y} F9000
#    G1 X{x_max} Y{y_min} F9000
#    G1 Z{start_z} F1500
### Wipe nozzle
#    {% for wipes in range(1, (wipe_qty + 1)) %} #wipe left and right
#        G1 Y{y_min} F{wipe_spd * 60}
#        G1 X{x_min} F{wipe_spd * 60}
#        G1 X{start_x} F{wipe_spd * 60}
#        G1 Y{y_max} F{wipe_spd * 60}
#        G1 X{x_min} F{wipe_spd * 60}
#        G1 X{start_x} F{wipe_spd * 60}
#        G1 Z{z1} F1500
#        G1 Y{y_min} F{wipe_spd * 60}
#        G1 X{x_min} F{wipe_spd * 60}
#        G1 X{start_x} F{wipe_spd * 60}
#        G1 Y{y_max} F{wipe_spd * 60}
#        G1 X{x_min} F{wipe_spd * 60}
#        G1 X{start_x} F{wipe_spd * 60}
#        G1 Z{z2} F1500
#        G1 Y{y_min} F{wipe_spd * 60}
#        G1 X{x_min} F{wipe_spd * 60}
#        G1 X{start_x} F{wipe_spd * 60}
  
#        G1 Y{y_max} F{wipe_spd * 60}
#        G1 X{x_min} F{wipe_spd * 60}
#        G1 X{start_x} F{wipe_spd * 60}
#  
#        G1 Z{start_z} F1500
#    {% endfor %}

#    {% for wipes in range(1, (wipe_qty + 1)) %} #wipe diagonally
#        G1 Z{start_z} F1500
#        G1 X{x_min} Y{y_min} F{wipe_spd * 60}
#        G1 X{x_max} Y{y_max} F{wipe_spd * 60}
#        G1 X{x_min} Y{y_min} F{wipe_spd * 60}
#        G1 X{x_max} Y{y_max} F{wipe_spd * 60}
#        G1 Z{z1} F1500
#        G1 X{x_min} Y{y_min} F{wipe_spd * 60}
#        G1 X{x_max} Y{y_max} F{wipe_spd * 60}
#        G1 X{x_min} Y{y_min} F{wipe_spd * 60}
#        G1 X{x_max} Y{y_max} F{wipe_spd * 60}
#        G1 Z{z1} F1500
#        G1 X{x_min} Y{y_max} F{wipe_spd * 60}
#        G1 X{x_max} Y{y_min} F{wipe_spd * 60}
#        G1 X{x_min} Y{y_max} F{wipe_spd * 60}
#        G1 X{x_max} Y{y_min} F{wipe_spd * 60}
#       G1 Z{z2} F1500
#        G1 X{x_min} Y{y_min} F{wipe_spd * 60}
#        G1 X{x_max} Y{y_max} F{wipe_spd * 60}
#        G1 X{x_min} Y{y_min} F{wipe_spd * 60}
#        G1 X{x_max} Y{y_max} F{wipe_spd * 60}
#        G1 X{x_min} Y{y_max} F{wipe_spd * 60}
#        G1 X{x_max} Y{y_min} F{wipe_spd * 60}
#        G1 X{x_min} Y{y_max} F{wipe_spd * 60}
#        G1 X{x_max} Y{y_min} F{wipe_spd * 60}
#        G1 X{start_x} Y{y_min} F{wipe_spd * 60}
#  
#        G1 Z{start_z} F1500
#    {% endfor %}

#    G1 X{start_x} Y{start_y} F9000 #go back to starting position
## Raise nozzle
#    G1 Z{raise_distance}

[gcode_macro CLEAN_NOZZLE_GANTRY]
gcode:
  STATUS_CLEANING
   SAVE_GCODE_STATE NAME=clean_nozzle_gantry
   G90
   G1 X32 F18000
   G1 X80 F18000
   G1 Y345 F18000
   G1 X34 F18000
   G1 X80 F18000
   G1 X32 F18000
   G1 X80 F18000
   G1 Y345 F18000
   G1 X34 F18000
   G1 X80 F18000
   G1 X32 F18000
   G1 X80 F18000
   G1 Y345 F18000
   G1 X34 F18000
   G1 X80 F18000
   G1 X175 Y175 F5000 NAME=clean_nozzle_gantry

[gcode_macro TEST_SPEED]
# Home, get position, throw around toolhead, home again.
# If MCU stepper positions (first line in GET_POSITION) are greater than a full step different (your number of microsteps), then skipping occured.
# We only measure to a full step to accomodate for endstop variance.
# Example: TEST_SPEED SPEED=300 ACCEL=5000 ITERATIONS=10

description: Test for max speed and acceleration parameters for the printer. Procedure: Home -> ReadPositionFromMCU -> MovesToolhead@Vel&Accel -> Home -> ReadPositionfromMCU

gcode:
    # Speed
    {% set speed  = params.SPEED|default(printer.configfile.settings.printer.max_velocity)|int %}
    # Iterations
    {% set iterations = params.ITERATIONS|default(5)|int %}
    # Acceleration
    {% set accel  = params.ACCEL|default(printer.configfile.settings.printer.max_accel)|int %}
    # Minimum Cruise Ratio
    {% set min_cruise_ratio = params.MIN_CRUISE_RATIO|default(0.5)|float %}
    # Bounding inset for large pattern (helps prevent slamming the toolhead into the sides after small skips, and helps to account for machines with imperfectly set dimensions)
    {% set bound = params.BOUND|default(20)|int %}
    # Size for small pattern box
    {% set smallpatternsize = SMALLPATTERNSIZE|default(20)|int %}
    
    # Large pattern
        # Max positions, inset by BOUND
        {% set x_min = printer.toolhead.axis_minimum.x %}
        {% if x_min < 0 %}
            {% set x_min = 0 %}
        {% endif %}
    
        {% set y_min = printer.toolhead.axis_minimum.y %}
        {% if y_min < 0 %}
            {% set y_min = 0 %}
        {% endif %}
    
        {% set x_min = x_min + bound %}
        {% set x_max = printer.toolhead.axis_maximum.x - bound %}
        {% set y_min = y_min + bound %}
        {% set y_max = printer.toolhead.axis_maximum.y - bound %}
    
    # Small pattern at center
        # Find X/Y center point
        {% set x_center = (printer.toolhead.axis_minimum.x|float + printer.toolhead.axis_maximum.x|float ) / 2 %}
        {% set y_center = (printer.toolhead.axis_minimum.y|float + printer.toolhead.axis_maximum.y|float ) / 2 %}
        
        # Set small pattern box around center point
        {% set x_center_min = x_center - (smallpatternsize/2) %}
        {% set x_center_max = x_center + (smallpatternsize/2) %}
        {% set y_center_min = y_center - (smallpatternsize/2) %}
        {% set y_center_max = y_center + (smallpatternsize/2) %}

    # Save current gcode state (absolute/relative, etc)
    SAVE_GCODE_STATE NAME=TEST_SPEED
    
    # Output parameters to g-code terminal
    { action_respond_info("TEST_SPEED: starting %d iterations at speed %d, accel %d" % (iterations, speed, accel)) }
    
    # Home and get position for comparison later:
        M400 # Finish moves - https://github.com/AndrewEllis93/Print-Tuning-Guide/issues/66
        G28
        # QGL if not already QGLd (only if QGL section exists in config)
        {% if printer.configfile.settings.quad_gantry_level %}
            {% if printer.quad_gantry_level.applied == False %}
                QUAD_GANTRY_LEVEL
                G28 Z
            {% endif %}
        {% endif %} 
        # Move 50mm away from max position and home again (to help with hall effect endstop accuracy - https://github.com/AndrewEllis93/Print-Tuning-Guide/issues/24)
        G90
        G1 X{printer.toolhead.axis_maximum.x-50} Y{printer.toolhead.axis_maximum.y-50} F{30*60}
        M400 # Finish moves - https://github.com/AndrewEllis93/Print-Tuning-Guide/issues/66
        G28 X Y
        G0 X{printer.toolhead.axis_maximum.x-1} Y{printer.toolhead.axis_maximum.y-1} F{30*60}
        G4 P1000 
        GET_POSITION

    # Go to starting position
    G0 X{x_min} Y{y_min} Z{bound + 10} F{speed*60}

    # Set new limits
    {% if printer.configfile.settings.printer.minimum_cruise_ratio is defined %}
        SET_VELOCITY_LIMIT VELOCITY={speed} ACCEL={accel} MINIMUM_CRUISE_RATIO={min_cruise_ratio}
    {% else %}
        SET_VELOCITY_LIMIT VELOCITY={speed} ACCEL={accel} ACCEL_TO_DECEL={accel / 2}
    {% endif %}

    {% for i in range(iterations) %}
        # Large pattern diagonals
        G0 X{x_min} Y{y_min} F{speed*60}
        G0 X{x_max} Y{y_max} F{speed*60}
        G0 X{x_min} Y{y_min} F{speed*60}
        G0 X{x_max} Y{y_min} F{speed*60}
        G0 X{x_min} Y{y_max} F{speed*60}
        G0 X{x_max} Y{y_min} F{speed*60}
        
        # Large pattern box
        G0 X{x_min} Y{y_min} F{speed*60}
        G0 X{x_min} Y{y_max} F{speed*60}
        G0 X{x_max} Y{y_max} F{speed*60}
        G0 X{x_max} Y{y_min} F{speed*60}
    
        # Small pattern diagonals
        G0 X{x_center_min} Y{y_center_min} F{speed*60}
        G0 X{x_center_max} Y{y_center_max} F{speed*60}
        G0 X{x_center_min} Y{y_center_min} F{speed*60}
        G0 X{x_center_max} Y{y_center_min} F{speed*60}
        G0 X{x_center_min} Y{y_center_max} F{speed*60}
        G0 X{x_center_max} Y{y_center_min} F{speed*60}
        
        # Small pattern box
        G0 X{x_center_min} Y{y_center_min} F{speed*60}
        G0 X{x_center_min} Y{y_center_max} F{speed*60}
        G0 X{x_center_max} Y{y_center_max} F{speed*60}
        G0 X{x_center_max} Y{y_center_min} F{speed*60}
    {% endfor %}

    # Restore max speed/accel/accel_to_decel to their configured values
    {% if printer.configfile.settings.printer.minimum_cruise_ratio is defined %}
        SET_VELOCITY_LIMIT VELOCITY={printer.configfile.settings.printer.max_velocity} ACCEL={printer.configfile.settings.printer.max_accel} MINIMUM_CRUISE_RATIO={printer.configfile.settings.printer.minimum_cruise_ratio} 
    {% else %}
        SET_VELOCITY_LIMIT VELOCITY={printer.configfile.settings.printer.max_velocity} ACCEL={printer.configfile.settings.printer.max_accel} ACCEL_TO_DECEL={printer.configfile.settings.printer.max_accel_to_decel}
    {% endif %}

    # Re-home and get position again for comparison:
        M400 # Finish moves - https://github.com/AndrewEllis93/Print-Tuning-Guide/issues/66
        G28 # This is a full G28 to fix an issue with CoreXZ - https://github.com/AndrewEllis93/Print-Tuning-Guide/issues/12
        # Go to XY home positions (in case your homing override leaves it elsewhere)
        G90
        G0 X{printer.toolhead.axis_maximum.x-1} Y{printer.toolhead.axis_maximum.y-1} F{30*60}
        G4 P1000 
        GET_POSITION

    # Restore previous gcode state (absolute/relative, etc)
    RESTORE_GCODE_STATE NAME=TEST_SPEED


[gcode_macro FAILED_PRINT_START]
gcode:
    {% set BED_TEMP = params.BED_TEMP|default(80)|float %}
	{% set EXTRUDER_TEMP = params.EXTRUDER_TEMP|default(240)|float %}
    # Use absolute coordinates
    M104 S120 ; set temporary nozzle temp to prevent oozing during homing
    M140 S{BED_TEMP} ; set final bed temp
    # Start bed heating
    G90
    # Reset the G-Code Z offset (adjust Z offset if needed)
    SET_GCODE_OFFSET Z=0.0
    # Home the printer
    #G28
    #Restore Bed Mesh
    BED_MESH_PROFILE LOAD=default
    #Raise z to maximum to avoid hitting the print when going to the "edge" of bed.  
    G1 Z250
    # Move Nozzle To Edge Of Bed
    G1 X2.0 Y8.0 F18000            ; go to edge of bed
    #Heat Bed and Nozzle
    M104 S{EXTRUDER_TEMP} ; set final nozzle temp
    M190 S{BED_TEMP} ; wait for bed temp to stabilize
    M109 S{EXTRUDER_TEMP} ; wait for nozzle temp to stabilize