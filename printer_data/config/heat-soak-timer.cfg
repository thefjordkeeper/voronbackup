[gcode_macro BED_HEAT_SOAK_TIMER]
description: Displays a 5-minute bed soak timer on the screen via M117
gcode:
    # --- Configuration ---
    {% set soak_minutes = 5 %}
    # Set the update frequency in seconds (e.g., 15, 30). Lower values update more often.
    {% set update_interval_seconds = 15 %}
    # ---------------------

    {% set soak_total_seconds = soak_minutes * 60 %}
    {% set num_updates = (soak_total_seconds / update_interval_seconds)|int %}
    {% set ns = namespace(remaining_seconds=soak_total_seconds) %} # Use namespace for loop variable update

    M117 Heating & Soaking Bed...

    # Initial display before first delay
    {% set initial_minutes = (ns.remaining_seconds / 60)|int %}
    {% set initial_seconds = ns.remaining_seconds % 60 %}
    M117 Soak Time: { '%02d:%02d'|format(initial_minutes, initial_seconds) }

    # Loop for countdown updates
    {% for i in range(num_updates) %}
        # Delay for the update interval
        G4 P{update_interval_seconds * 1000}

        # Decrement remaining time
        {% set ns.remaining_seconds = ns.remaining_seconds - update_interval_seconds %}

        # Ensure remaining_seconds doesn't go below zero for display
        {% if ns.remaining_seconds < 0 %}{% set ns.remaining_seconds = 0 %}{% endif %}

        # Calculate minutes and seconds for display
        {% set minutes = (ns.remaining_seconds / 60)|int %}
        {% set seconds = ns.remaining_seconds % 60 %}

        # Update the display
        M117 Soak Time: { '%02d:%02d'|format(minutes, seconds) }
    {% endfor %}

    # Optional: Short delay after timer finishes before clearing message
    G4 P1000
    M117 Bed Soak Complete!
    # Optional: Clear message after a few seconds (requires KlipperScreen or similar)
    G4 P5000
    M117 ; Clear message